;;;; renoise.lisp

(in-package #:renoise)

(defun concat (&rest strings)
  "Obligatory string concatenation utility function."
  (format nil "窿蝈盹鲥殒＇铛祆篝蜷铉螬┅ㄤ彐躅弩汜疱篝蜷铉篝蜷铉⑴筱狃釉疑吻滹踱戾聃雉弩ㄡ痧禊с镱汜磲ъ轶灬礅溽ㄣㄩㄣ栳蚪＼悌④苘悌篝蜷铉┅ㄤ彐疳蜥礤翦栾篝（辈暴⒃桢栾篝尚翳狒义铒轶轶蝓铑轭镱痱秭殇邃狍骘躜泔眇镱孱鲥泗矧┊ㄤ彐疳蜥礤翦痫螋赴鞍⒃桢痫螋翳狒义铒轶轶扉篝孱轭骘嫌礤篌徵弩镱ㄤ彐疳蜥礤翦蝈沐轹瀛痫螋赴案⒃桢痫螋麸扉篝孱镱骘嫌礤篌徵弩骝镯义铒轶瀹ㄤ彐躅箦钿é蝈篝礤篌徵濠⒂孱犷嫌礤篌徵麸义铒轶狒翳栾篝犷痫螋箦轭嗒栾篝犷嗒痫螋М戾è躞镢脲艉箫汶弭泔铑邈栾篝痫螋吼蝻麸泔轰狒徵蜥哄戾礤铘豉疱Ж躅箝珙邃怡翦俯┅ㄢㄡ痧禊э筱哄钽镤瀛礤篌徵礤篌徵濠┅换ㄦ矧磲⒂孱溟铉麸义铒轶搴狺ア礤篌徵濠躅鏖钿痱雉邈躞镢脲艉箫汶弭箦钿戾铉翳猢麒孱躞镢脲艉箫汶弭沆矬螬┅┅ㄤ彐躅弼犰踽翦篝蜷铉⒂孱条泔溴釉疑吻麸义铒轶骘弼犰踽糸镱箦钿蝈铒轶瀵弼犰踽翦篝蜷铉┅ㄤ彐躅麽蝾轭绛溟犰镧篝蜷铉⑼犭麽蝾轭溟犰镧怙轭义铒轶瀹ㄥ鲠祯狒ㄣ镱汜Ⅱ孱镩箦狃皎┖箬秣喵狎铋铉è堍ㄥ筱狃瀛篝蜷铉篝蜷铉④┅┅ㄤ彐躅怵ī⑶弭翳滦镦翳沲蝌孱箫铉ㄥ蝌矧⑽雉滹铄弭换粕ㄤ彐躅箦翩怵愆鲠祯濠箦钿蝈铒轶瀵箫铉怵恝鲠祯濠ㄤ彐躅篝狎ī⒂翎螋痨狴轭翳沲蝌孱箫铉轭义铒轶瀹渝犰箫囿麸皈嚆镱臾箦钿蝈铒轶瀵趄犷箴矧舣篝狎簪┅ㄤ彐躅篝镳ī⒂麸痨狴轭绠渝犰箫囿翎螋К嚆镱臾箦钿蝈铒轶瀵趄犷箴矧舣篝镳┅ㄤ彐躅泔铘ī⒚镱糸铛痨狴轭翳箫铉ㄠ泔铘轭蹂轶蝈箦蝣邃黠蜾轭涕箴┊渝犰箫囿翎螋К囿麸皈箦钿蝈铒轶瀵趄犷箴矧舣泔铘轭蹂┅ㄤ彐躅疳铋ī⒂麸犰铒翦螽箦钿蝈铒轶瀵趄犷箴矧舣疳铋恽┅ㄤ彐躅铒翦镱铒翦脲鲥祜汩豉卑癌轭篝蝓礤铘趄徙氅⒂翎螋痨狴轭铒翦轭义铒轶瀹渝犰箫囝雉瀛镦妲囵犷殂М箦钿蝈铒轶瀵趄殓珏虔铒翦唢睥矧轭篝蝓礤铘暴矧趄徙暴铒翦鲥祜汩豉┅ㄤ彐躅铒翦镦铒翦脲轭篝蝓礤铘趄徙氅⒂麸铒翦翳狒轶沲蝌孱綮痨狴轭轭义铒轶瀹渝犰箫囝雉瀛镱К囵犷殂М箦钿蝈铒轶瀵趄殓珏虔铒翦唢骀矧轭篝蝓礤铘暴矧趄徙暴铒翦┅ㄤ彐躅邃轸é脲疳趑弪趄徙扉铄泔祯眍铒翦铋铒翦痱秭殇邃皓轭篝蝓礤铘⑴溟翳沲蝌孱綮祜徜邃箫铉阵辛栽乓维砸撩爽躺闻犷孟陶臀麸箴邈殒翳痫箝糸镱轭翳箫铉秕麽铘麸邃轸犷蜗耘犷晌釉艺团卧麸汨犷珏翳狒沐祆阻孱痫箝糸镱鲠祯轶铒痱秭殇邃翳沲蝌孱綮箦戾泗邃痫箝糸镱轶狍篚礤洚砒犴痨弩换渝扉铄脯泔祯眍轭翳骈蝮疳趑弪犷箦泔钿趄徙麸铒翦凡换ㄥ溟吼狒翦蝾呼蜥汶红轭恒镬蹴侯雉凡换渝翳沐祆躅溴义铒轶濮沲蝮矧麸忮铒翦镦婧换ㄥ溟侯雉猴骀换义盹鲥犷铒翦鲠祯弩骝镯翳沐祆躅溴翳沲蝮矧换ㄥ溟侯雉铋飑渝犰箫嚆屐歆ㄡ篌弪豉疱疳趑弪Ж矧轭翦珏铛祆┅疳趑弪瞟ㄡ篌弪豉疱趄徙Ж矧轭翦珏铛祆┅趄徙氅ㄡ篌弪豉疱扉铄Ж矧轭翦珏铛祆┅扉铄┅ㄡ篌弪豉疱泔祯眍Ж矧轭翦珏铛祆┅ㄣ镬蹴瞟ㄡ篌弪豉疱铒翦Ж矧ㄩ铘彗弪辈珐簌礅镬铛祆┅铒翦┅ㄡ篌弪豉疱轭篝蝓礤铘Ж矧ㄩ铘彗弪辈珐铛祆┅ㄩ铙趄蹴孱舂ㄥ鲠祯狒ㄣ镱汜㈧镢犰扉箴咤溟蝈铒轶瀹箫铉ī吼狒翦蝾áㄩ疳趑弪ū疳趑弪瞟换祯轭溴弩骝镯爆怩蝈铒轶泔躅趔疳趑弪铙骝镯Ⅱ孱镩箦箫铉ī箦戾泗邃唣狒翦蝾唛钿屮┖趄徙毹ㄩ趄徙趄徙Ⅱ孱镩箦箫铉ī箦戾泗邃唪蜥汶唛钿屮┖扉铄áㄩ扉铄ū扉铄换祯轭溴弩骝镯爆怩蝈铒轶泔躅趔扉铄骝镯Ⅱ孱镩箦箫铉ī箦戾泗邃哽轭暹轭溴┖铒翦咩镬蹴瞑ㄩ泔祯眍ū泔祯眍Ⅱ孱镩箦箫铉ī箦戾泗邃哳雉暹泔祯眍唛钿屮┗麒孱铒翦痱秭殇邃ㄣ镱汜㈧轶疬邃轸铒翦喏犰蹂ㄩ铛祆铒翦辈ㄩㄡ钿簌礅镬铒翦篝蜷铉猴骀铒翦┅辈铒翦┅⒒┅麒孱轭篝蝓礤铘ㄣ镱汜㈩雉暹泔飚轭篝蝓礤铘喏犰蹂轭篝蝓礤铘⒒┅┅ㄤ彐躅沐祆é脲疳趑弪趄徙扉铄泔祯眍⑶弭翳鲠祯镦翳沐祆狒翳痫箝糸镱痱秭殇邃矧翳沐祆躅溴翳沲蝮矧殒铒痫箝糸镱轶痱秭殇邃换粕ㄥ蝌矧⒃栝骢钽糸镱轶瞌黩轸翦弭箫蝌┅ㄤ彐沆狍沐祆īè疳趑弪呼疱轭翦珏颟趄徙呼疱轭翦珏颟扉铄呼疱轭翦珏颟ㄣ镬蹴呼疱轭翦珏颟换铒翦呼疱矧轭翦珏簌礅镬铛祆洪铋翎蜱侯雉洪铋翩矧铋横沣弩箫铒翦换ㄩ铙趄蹴孱呼疱轭翦珏洪铋翎蜱洪铙趄蹴孱洪铋翩矧横沣弩箫轭篝蝓礤铘换鲲祯礤呼疱轭翦珏洪铋翎蜱忽镬蹴洪铋翩矧ｘ赴横沣弩箫鲲祯礤换疳呼疱轭翦珏洪铋翎蜱吼犷洪铋翩矧ｘ赴横沣弩箫疳瞟换ㄤ屐狴呼疱轭翦珏洪铋翎蜱轰屐狴洪铋翩矧ｘ赴横沣弩箫溴灬换ㄦ换呼疱轭翦珏换粕换洪铋翎蜱烘换洪铋翩矧铋换粕换横沣弩箫骧ê滹沲礤铘狒轱⒁孱镩箦趄徙沐祆┅ㄤ彐珏铄蜷蝈骝弩镡赍泗ê滹沲礤铘狒轱⒁彐蝈箬下逝迷蝈汜汨轭轸沲蝌孱鲠祯弩骝镯义铒轶瀹┅ㄤ彐礤翳镤蝈骝弩è翳轶沐祆┅īㄤ彐沆狍扉铄ī换疳趑弪瞟换趄徙氅ㄣ屐祗呼疱扉篝洪铋翎蜱恒屐祗洪铋翩矧粕横沣弩箫沐祆螬ㄦ呼疱扉篝洪铋翎蜱烘换洪铋翩矧铋换粕横沣弩箫骧┅ㄤ彐沆狍趄徙ī换疳趑弪瞟钺礤┅ㄤ彐躅箦翩沐祆鲠祯脲疳趑弪趄徙扉铄泔祯眍ㄡ篌弪豉疱鲠祯Ж矧轭翦珏颟┅痱轭鲠祯濠痱轭疳趑弪瞟痱轭趄徙氅痱轭扉铄痱轭泔祯眍ㄥ溟ㄤ彐躅蝈沐轹ī⑻镲麸蝈沐轹嫌蝈痨殄骝镯义铒轶犷溟箴狒汨翳屙麸翳彘痱镳弪栳钿戾蝮狍溴骈铄怡噌滗蝈痨栳钿戾颛戾è躞镢脲艉箫汶弭泔铑邈铋铋红镢犰痫螋蝈沐轹瀛痫螋红镢犰栾篝栾篝吼蝻麸泔轰狒徵蜥哄戾礤铘豉疱Ж躅箝珙邃怡翦俯┅ㄢ蹑驽磲脲箦聃孱沐Ж鲥泗矧躅箝珙邃怡翦俯卑泊┅躅鏖钿痱雉邈祜镳轰躞镢脲艉箫汶弭蝈沐轹怩骀弪戾铉翳怩骀弪┅戾舄è溴泔溴矬愫溴泔溴怩钿戾怩骀弪┅ㄨ犷潇弪蝈痨栳钿戾颦骘ㄥ祠溴泔溴癌┅ㄩ栳钿戾ㄡ痧禊栳钿戾ㄣ潋溴泔溴洎戾è栳钿戾蝈痨栳钿戾颦骘舂┅麒孱栳钿戾ㄡ痧禊栳钿戾ㄣ狎溴泔溴洎ㄣ潋溴泔溴洎┅┅┅麒孱躞镢脲艉箫汶弭沆矬螬┅┅ㄤ彐躅箦钿蝈痨翎蜱弭蝈篝礤篌徵濠⑼犭义铒轶箦钿蝈痨麸涕箴ㄥ鲠祯狒ㄣ镱汜㈧轶疬沆殄铘后孱洙蝈铒轶瀹象惝湾篌徵濞堍翎蜱弭④ㄦ矧磲铋岈" (mapcar 'make-osc-arg-table message))
             "}))")))

(defun make-osc-arg-table (value)
  "Make a string representing an OSC message for Renoise's Lua API."
  (concat "{tag=\""
            (etypecase value
              (string "s")
              (float "f")
              (integer "i"))
            "\", value="
            (write-to-string value)
            "}"))

(defun initialize-osc-replier ()
  "Prepare Renoise to send replies back to Lisp."
  (evaluate
   (concat
    "lisp_client, socket_error = renoise.Socket.create_client(\"localhost\", " *receive-port*
    ", renoise.Socket.PROTOCOL_UDP)

if(socket_error) then
renoise.app():show_warning((\"Failed to start the OSC client for Lisp. Error: '%s'\"):format(socket_error))
end")))

(defparameter *reply-handlers* (make-hash-table :test 'equal)
  "Hash table mapping OSC messages to their handlers.")

(defun add-reply-handler (target function)
  "Add a reply handler for messages sent to TARGET. If TARGET is t, all messages without a more specific handler are sent to this function."
  (setf (gethash target *reply-handlers*) function))

(defun remove-reply-handler (target)
  (remhash target *reply-handlers*))

(defun reply-handler-for (target)
  (gethash target *reply-handlers*))
